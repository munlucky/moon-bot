{"type":"entity","name":"moonbot::Boundary::AlwaysDo","entityType":"boundary","observations":["커밋 전 pnpm lint 실행","TypeScript 빌드 통과 확인 (pnpm build)","보안 검토 후 하드코딩된 시크릿 없는지 확인","*-config.json 파일 .gitignore에 추가","개인 설정 파일 커밋 전 확인"]}
{"type":"entity","name":"moonbot::Boundary::AskFirst","entityType":"boundary","observations":["새로운 채널 어댑터 추가 시","외부 포트 바인딩 설정 변경 시","세션 저장 경로 구조 변경 시","핵심 도구(Browser, HTTP, Desktop) 승인 정책 수정 시"]}
{"type":"entity","name":"moonbot::Boundary::NeverDo","entityType":"boundary","observations":["하드코딩된 API 키/토큰 커밋",".env 파일 커밋","루프백이 아닌 외부 바인딩 시 인증 없이 노출","SSRF 보호 없이 HTTP 도구 사용"]}
{"type":"entity","name":"moonbot::Component::Gateway","entityType":"component","observations":["WebSocket 서버 (포트 18789)","JSON-RPC 프로토콜 핸들러","세션/채널/노드/훅 통합 관리","파일 위치: src/gateway/","chat.send 핸들러: 처리 후 chat.response 브로드캐스트","TaskResponse 타입 도입 (channelId, text, status, metadata)"]}
{"type":"entity","name":"moonbot::Component::Channels","entityType":"component","observations":["멀티 서피스 채널 어댑터","Discord 어댑터 구현 (discord.js)","Mention Gating (@agent 언급 시만 활성화)","DM 페어링 승인 흐름","파일 위치: src/channels/","Discord Adapter: ChannelGatewayClient 통합 (자동 Gateway 연결)","chat.response notification 수신 및 Discord 채널로 전달","sendToGateway: WebSocket으로 chat.send RPC 호출"]}
{"type":"entity","name":"moonbot::Component::Agents","entityType":"component","observations":["Planner-Executor-Replanner 모델","Planner: 목표 분해 (고성능 LLM)","Executor: 도구 호출 및 결과 수집","Replanner: 실패 시 대체 도구 선택","파일 위치: src/agents/","Planner: LLM 연동 완료 (P0 TODO 해결)","LLMClient를 통해 OpenAI/GLM 프로바이더 지원","keyword fallback 기능 유지"]}
{"type":"entity","name":"moonbot::Component::Tools","entityType":"component","observations":["TypeBox 기반 JSON Schema 계약","Browser Tool: Playwright 웹 제어","HTTP Tool: API 호출 + SSRF 가드","Filesystem Tool: 파일 I/O + 경로 검증","Desktop Tool: system.run + 명령어 sanitization","Approval System: Lobster 승인 흐름","파일 위치: src/tools/","tools.listDefinitions 핸들러 추가 (2026-01-30)","사용자가 읽을 수 있는 형태로 도구 목록 제공 (id, name, description)"]}
{"type":"entity","name":"moonbot::Component::Sessions","entityType":"component","observations":["JSONL 형식 저장","저장 경로: ~/.clawdbot/agents/<agentId>/sessions/<sessionId>.jsonl","세션 공유 (sessions.send)","컴팩션 및 리플레이 기능","파일 위치: src/sessions/"]}
{"type":"entity","name":"moonbot::Component::Cron","entityType":"component","observations":["예약 작업 관리","cron.list, cron.edit, cron.run 명령","하트비트 및 이벤트 기반 발화","파일 위치: src/cron/","Agent 연동 완료 (P1 TODO 해결)","executeJob()에서 orchestrator.createTask() 호출","cron:{jobId} 형식의 channelSessionId 사용","ChatMessage 필드 자동 완성 (agentId, channelId, userId)"]}
{"type":"entity","name":"moonbot::Component::Auth","entityType":"component","observations":["사용자 페어링 승인","인증 토큰 관리","allowFrom 기반 접근 제어","파일 위치: src/auth/"]}
{"type":"entity","name":"moonbot::Component::CLI","entityType":"component","observations":["명령어: moonbot gateway status, logs, doctor, call, pairing","Gateway 직접 RPC 호출 지원","보안/권한 진단 기능","파일 위치: src/cli/","npm 스크립트: cli (node dist/cli.js)","npm 스크립트: discord (node dist/discord-bot.js)"]}
{"type":"entity","name":"moonbot::Convention::ToolRegistration","entityType":"convention","observations":["toolkit.register({ id, schema, run }) 인터페이스","TypeBox 사용한 스키마 정의","requiresApproval 옵션으로 승인 필요 도구 지정","평탄화된 구조 권장"]}
{"type":"entity","name":"moonbot::Convention::Naming","entityType":"convention","observations":["컴포넌트 파일: PascalCase (예: BrowserTool.ts)","타입 정의: 인터페이스/타입 분리","CLI 명령: kebab-case (예: gateway status)"]}
{"type":"entity","name":"moonbot","entityType":"project","observations":["Local-first AI Agent System","Moltbot 프레임워크 기반","TypeScript (ESM), Node.js 22+","WebSocket JSON-RPC (포트 18789)","멀티 서피스 채널 (Discord 등)","CLI: moonbot","PRD: local_ai_agent_prd.md","Spec: agent_system_spec.md","README.md 문서 추가 (프로젝트 개요, 설치, 빠른 시작 가이드)","문서: USER_GUIDE.md (사용자 가이드, 채널별 설정, config import 가이드)","예제 설정: docs/config.example.json","문서 현행화 완료 (2026-01-29)","agent_system_spec.md v2.1: LLM 인프라 섹션 추가","local_ai_agent_prd.md v2.1: 구현 현황 표 업데이트","PROJECT.md: LLM 환경변수 추가"]}
{"type":"entity","name":"moonbot::Component::ChannelCommand","entityType":"component","observations":["CLI 채널 관리 명령어 (add, remove, list, enable, disable)","위치: src/cli/commands/channel.ts","RPC 클라이언트를 통해 Gateway와 통신","토큰 마스킹 기능 적용 (maskToken)","에러 핸들링: ECONNREFUSED, not found, already exists"]}
{"type":"entity","name":"moonbot::Component::ConfigManager","entityType":"component","observations":["설정 관리자 모듈","위치: src/config/manager.ts","기능: loadConfigAsync, saveConfig, addChannel, removeChannel, updateChannel","환경 변수 우선순위: env > config.json > defaults","자동 백업 (최대 10개 보관)","토큰 마스킹 함수 제공"]}
{"type":"entity","name":"moonbot::Component::ChannelHandler","entityType":"component","observations":["Gateway RPC 채널 핸들러","위치: src/gateway/handlers/channel.handler.ts","메서드: list, add, remove, enable, disable, get","ConfigManager를 통해 설정 파일 CRUD"]}
{"type":"entity","name":"moonbot::API::EnvironmentVariables","entityType":"api","observations":["지원 변수: MOONBOT_DISCORD_TOKEN, MOONBOT_GATEWAY_PORT, MOONBOT_GATEWAY_HOST","우선순위: 환경 변수 > config.json > 기본값","Discord 토큰이 있으면 자동으로 discord 채널 생성/업�데이트"]}
{"type":"entity","name":"moonbot::Convention::TokenMasking","entityType":"convention","observations":["보안을 위해 모든 토큰 출력 시 마스킹 적용","형식: 앞 6자리 + ... + 뒤 4자리","함수: maskToken() in src/config/manager.ts","적용 위치: channel list, channel add 출력"]}
{"type":"entity","name":"moonbot::Convention::EnvVarNaming","entityType":"convention","observations":["환경 변수 네이밍: MOONBOT_<SECTION>_<KEY>","예: MOONBOT_DISCORD_TOKEN, MOONBOT_GATEWAY_PORT","섹션: DISCORD, GATEWAY, STORAGE 등"]}
{"type":"entity","name":"moonbot::Component::ConfigCommand","entityType":"component","observations":["CLI 설정 관리 명령어 (import, export, path)","위치: src/cli/commands/config.ts","config import <file>: JSON 파일에서 설정 가져오기","config export <file>: 현재 설정 내보내기","config path: 설정 파일 위치 표시","--force 옵션으로 기존 설정 덮어쓰기","자동 백업 생성 (최대 10개 보관)"]}
{"type":"entity","name":"moonbot::Component::DiscordBot","entityType":"component","observations":["Discord 봇 실행 엔트리 포인트","위치: src/discord-bot.ts","활성화된 Discord 채널 자동 시작","SIGINT 핸들링으로 graceful shutdown","별도 프로세스로 실행 (npm run discord)"]}
{"type":"entity","name":"moonbot::Component::ChannelGatewayClient","entityType":"component","observations":["채널 어댑터용 WebSocket 클라이언트","위치: src/channels/GatewayClient.ts","자동 재연결 (exponential backoff, 최대 10회)","EventEmitter 기반 notification 핸들링","RPC 타임아웃 (30초 기본)","Gateway와 JSON-RPC 통신"]}
{"type":"entity","name":"moonbot::Component::TaskOrchestrator","entityType":"component","observations":["태스크 생성 및 상태 관리 (PENDING/RUNNING/FAILED/DONE)","Per-channel 실행 큐 관리","Gateway에서 chat.send 요청을 받아 Task로 변환","Task 실행 결과를 chat.response로 브로드캐스트","src/orchestrator/TaskOrchestrator.ts가 핵심 구현체","2026-01-29: 스켈레톤 구현 완료 (Echo placeholder 포함)","grantApproval(taskId, approved): PAUSED 상태 태스크 승인/거부 메서드 추가","getPendingApprovals(): 대기 중 승인 목록 반환 메서드 추가","onApprovalRequest(callback): 승인 요청 이벤트 콜백 등록 메서드 추가","onApprovalResolved(callback): 승인 완료 이벤트 콜백 등록 메서드 추가","emitApprovalRequest(): 승인 요청 이벤트 방출 메서드 추가","emitApprovalResolved(): 승인 완료 이벤트 방출 메서드 추가","ApprovalRequestEvent, ApprovalResolvedEvent 타입 사용","27개 단위 테스트로 기능 검증 완료","cleanupSessionMappings(taskId): sessionTaskMap cleanup을 위한 private 메서드 추가","abortTask, processTask finally, approval 거부 시 cleanupSessionMappings 호출로 cleanup 통합","executeTaskLogic에서 executor 실행 전 sessionTaskMap 설정 (approvalRequested 이벤트 처리 버그 수정)","36개 단위 테스트로 기능 검증 완료 (기존 27개 + 승인 플로우 9개)"]}
{"type":"entity","name":"moonbot::Component::TaskRegistry","entityType":"component","observations":["In-memory Task 저장소","Task 상태 전이 관리 (PENDING -> RUNNING -> FAILED|DONE)","task_id 생성 규칙: UUID + timestamp","Task 이벤트 리스너 지원","src/orchestrator/TaskRegistry.ts에 구현"]}
{"type":"entity","name":"moonbot::Component::PerChannelQueue","entityType":"component","observations":["채널별 독립적인 FIFO 큐","채널 간 병렬 처리 가능하지만 동일 채널 내 순서 보장","처리 중 상태 추적 (startProcessing/stopProcessing)","최대 큐 크기 제한 (기본 100)","src/orchestrator/PerChannelQueue.ts에 구현","remove(item) 메서드 추가: 큐에서 항목 제거","채널 격리 테스트: 다른 채널 간 큐 독립성 검증","42개 단위 테스트로 기능 검증 완료 (enqueue/dequeue, FIFO, queue full, channel isolation, remove, processing state, getStats, clear, cleanup)"]}
{"type":"entity","name":"moonbot::API::chat.send","entityType":"api","observations":["Gateway RPC 메서드","채널에서 메시지를 받아 TaskOrchestrator로 위임","ChatMessage 파라미터: {agentId, text, userId, channelId, metadata}","반환값: {status, taskId, state}","src/gateway/server.ts에 구현"]}
{"type":"entity","name":"moonbot::API::chat.response","entityType":"api","observations":["Gateway notification 메서드","Task 실행 결과를 채널로 브로드캐스트","TaskResponse 포맷: {taskId?, channelId, text, status, metadata}","DiscordAdapter가 수신하여 Discord로 전송"]}
{"type":"entity","name":"moonbot::Convention::TaskStateMachine","entityType":"convention","observations":["Task 상태: PENDING -> RUNNING -> (FAILED|DONE)","상태 전이 유효성 검사: PENDING->RUNNING, RUNNING->DONE/FAILED만 허용","task_id는 UUID + timestamp로 고유성 보장","channelSessionId를 기준으로 per-channel 큐에 등록"]}
{"type":"entity","name":"moonbot::Convention::ErrorFormat","entityType":"convention","observations":["에러 포맷 분리: 사용자 메시지(userMessage) vs 내부 로그(internalMessage)","userMessage: 채널로 전송되는 사용자 친화적 메시지","internalMessage: 로그에만 남기는 상세 내용","코드 포맷: {code, userMessage, internalMessage?, stack?}"]}
{"type":"entity","name":"moonbot::Component::GatewayServer","entityType":"component","observations":["WebSocket 기반 Gateway 서버","JSON-RPC 메시지 처리","ToolRuntime 통합","2026-01-29: TaskOrchestrator 통합 완료","생성자에서 TaskOrchestrator 초기화 및 onResponse callback 등록","chat.send 핸들러에서 Orchestrator.createTask로 위임","stop() 시 orchestrator.shutdown() 호출","getOrchestrator() 메서드 추가","approval.grant RPC 핸들러: PAUSED 태스크 승인/거소 처리","approval.list RPC 핸들러: 대기 중 승인 목록 반환","orchestrator.onApprovalRequest() 콜백 연결: 'approval.requested' 브로드캐스트","orchestrator.onApprovalResolved() 콜백 연결: 'approval.resolved' 브로드캐스트","Gateway ↔ TaskOrchestrator Integration 테스트 8개 추가 (src/gateway/integration.test.ts)","WebSocket 실제 연결을 통한 chat.send, approval.grant, approval.list RPC 테스트","chat.response 브로드캐스트 수신 검증 테스트","Toolkit의 runtime을 공유하도록 수정 (2026-01-30)","별도의 ToolRuntime 생성하지 않고 Toolkit.getRuntime() 사용"]}
{"type":"entity","name":"moonbot::Type::Task","entityType":"type","observations":["Task 인터페이스 정의 (src/types/index.ts)","필드: id, state, channelSessionId, message, createdAt, updatedAt, error?, result?","TaskState 타입: PENDING | RUNNING | FAILED | DONE","TaskError 타입: {code, userMessage, internalMessage?, stack?}","TaskEvent 타입: {taskId, previousState, newState, timestamp}"]}
{"type":"entity","name":"moon-bot::Component::TaskOrchestrator","entityType":"component","observations":["태스크 라이프사이클 관리 및 채널별 큐 실행","Executor와 통합하여 실제 작업 실행","승인 이벤트 핸들링 (APPROVAL_REQUESTED/RESOLVED)","TaskStateChangeEvent 방출 (채널 ID 포함)","abortTask() 메서드로 태스크 중단 지원","Toolkit, SessionManager, Executor 의존성 주입","sessionTaskMap으로 세션-태스크 매핑"]}
{"type":"entity","name":"moon-bot::Component::SessionKey","entityType":"component","observations":["Moltbot 호환 sessionKey 유틸리티","형식: agent:<id>:session:<key>","parse(), generate(), isValid() 함수 제공","src/sessions/SessionKey.ts에 구현"]}
{"type":"entity","name":"moon-bot::Convention::TaskState","entityType":"convention","observations":["태스크 상태: PENDING -> RUNNING -> DONE/FAILED/PAUSED/ABORTED","PAUSED 상태는 승인 대기 중임을 나타냄","ABORTED 상태는 사용자 요청 또는 거부로 중단됨","TaskRegistry에서 상태 전이 규칙 검증"]}
{"type":"entity","name":"moon-bot::Feature::TaskOrchestratorExecutorIntegration","entityType":"feature","observations":["P0: TaskState 확장, SessionKey, Executor 통합, 의존성 주입 완료","P1: 승인 이벤트 핸들러, 상태 이벤트 방출, abortTask() 구현 완료","TypeScript 컴파일 검증 통과","커밋 aea5ab4: 7개 파일, 507줄 추가"]}
{"type":"entity","name":"moonbot::TestingFramework::Vitest","entityType":"testing-framework","observations":["Vitest 테스트 프레임워크 추가 (2026-01-29)","Node 환경 설정 (environment: 'node')","V8 커버리지 도구 사용 (@vitest/coverage-v8)","설정 파일: vitest.config.ts","테스트 파일: *.test.ts 패턴","PerChannelQueue: 42개 단위 테스트 (enqueue/dequeue, FIFO, queue full, channel isolation, remove method, processing state, getStats, clear, cleanup)","TaskOrchestrator: 27개 단위 테스트 (task creation, state transitions, timeout, abort, approval flow, callbacks, stats, cleanup, edge cases)","pnpm devDependencies: vitest, @vitest/coverage-v8"]}
{"type":"entity","name":"moonbot::Type::ApprovalRequestEvent","entityType":"type","observations":["승인 요청 이벤트 타입 (src/orchestrator/types.ts)","필드: taskId (string), channelId (string), toolId (string), input (unknown), requestId (string)","TaskOrchestrator에서 승인이 필요한 작업 요청 시 방출","Gateway Server를 통해 클라이언트로 'approval.requested' notification 브로드캐스트"]}
{"type":"entity","name":"moonbot::Type::ApprovalResolvedEvent","entityType":"type","observations":["승인 결과 이벤트 타입 (src/orchestrator/types.ts)","필드: taskId (string), channelId (string), approved (boolean), requestId (string)","TaskOrchestrator에서 승인/거부 결정 후 방출","Gateway Server를 통해 클라이언트로 'approval.resolved' notification 브로드캐스트"]}
{"type":"entity","name":"moonbot::Pattern::ApprovalFlow","entityType":"pattern","observations":["승인 흐름 패턴: Task PAUSED -> 승인 요청 -> 승인/거부 -> Task 상태 변경","TaskOrchestrator.grantApproval(taskId, approved): PAUSED 상태 태스크 승인/거부","TaskOrchestrator.getPendingApprovals(): 대기 중 승인 목록 반환","TaskOrchestrator.onApprovalRequest(callback): 승인 요청 이벤트 리스너 등록","TaskOrchestrator.onApprovalResolved(callback): 승인 완료 이벤트 리스너 등록","Gateway Server RPC handlers: approval.grant (승인/거부), approval.list (대기 목록 조회)","이벤트 방출: emitApprovalRequest(), emitApprovalResolved()"]}
{"type":"entity","name":"moonbot::Convention::Testing","entityType":"convention","observations":["Vitest 프레임워크 사용","*.test.ts 파일은 tsconfig.json에서 exclude로 빌드 제외","테스트 명령어: pnpm test (watch), pnpm test:run (단번), pnpm test:coverage (커버리지)","describe-it 패턴 사용, 한글 테스트 설명 허용"]}
{"type":"entity","name":"moonbot::Component::LLMClient","entityType":"component","observations":["OpenAI gpt-4o 연동을 위한 클라이언트 (src/llm/LLMClient.ts)","generatePlan() 메서드로 LLM을 호출하여 Step 배열 생성","fallback 기능 제공: LLM unavailable 시 keyword-based planning","환경 변수 OPENAI_API_KEY 필요","buildResponseSystemPrompt()에 toolDefinitions 파라미터 추가 (2026-01-30)","응답 생성 시 도구 목록을 프롬프트에 포함하여 LLM이 자체적으로 도구 안내 가능","LLMResponseRequest 인터페이스에 toolDefinitions 필드 추가"]}
{"type":"entity","name":"moonbot::Component::Planner","entityType":"component","observations":["LLM 연동 완료: LLMClient 사용하여 Step 생성","availableTools를 생성자에서 받아 LLM 프롬프트에 포함","keyword fallback: LLM unavailable 시 기존 키워드 매칭 로직 사용"]}
{"type":"entity","name":"moonbot::Component::Executor","entityType":"component","observations":["ToolRuntime.invoke() 사용하여 도구 실행","awaitingApproval 반환 시 approval flow 지원","toolRuntime 프로퍼티 추가 (Toolkit에서 가져옴)","2026-01-30: 각 step 완료 메시지 제거 (Discord 스팸 방지)","step 완료 시 messages.push() 제거, 최종 결과만 전송","generateAssistantResponse()에서 toolDefinitions를 LLM에 전달 (2026-01-30)","Toolkit.getDefinitions()를 호출하여 도구 스키마 전체를 획득"]}
{"type":"entity","name":"moonbot::Component::CronManager","entityType":"component","observations":["TaskOrchestrator 의존성 주입 지원","executeJob()에서 TaskOrchestrator.createTask() 호출","cron専用 channelSessionId 생성 (cron:{jobId})"]}
{"type":"entity","name":"moonbot::Component::DiscordAdapter","entityType":"component","observations":["sendEmbed() 메서드 추가: Discord Embed 메시지 전송","editMessage() 메서드 추가: 기존 메시지 수정","승인 요청/업데이트에 Embed 사용"]}
{"type":"entity","name":"moonbot::Component::CommandSanitizer","entityType":"component","observations":["새 허용 명령어: make, cmake, tar, zip, unzip","보안 검토 완료: build tools과 archive tools만 추가","docker, kubectl 제외: 컨테이너 조작 위험"]}
{"type":"entity","name":"moonbot::Integration::OpenAI","entityType":"integration","observations":["gpt-4o 모델 사용","temperature 0.7, maxTokens 2000","시스템 프롬프트에 도구 목록 포함","JSON 형식으로 Step 배열 반환"]}
{"type":"entity","name":"[moonbot]::Component::LLMProviderFactory","entityType":"component","observations":["LLM provider 생성 팩토리 (src/llm/LLMProviderFactory.ts)","detectProvider()로 자동 프로바이더 감지 (openai/glm)","buildProviderConfig()로 프로바이더별 설정 구성","ZAI_API_KEY/GLM_API_KEY/OPENAI_API_KEY 순서로 감지"]}
{"type":"entity","name":"[moonbot]::Component::GLMProvider","entityType":"component","observations":["Z.AI(智谱AI) LLM 프로바이더 (src/llm/providers/GLMProvider.ts)","OpenAI SDK baseURL 활용으로 최소 구현","표준 API와 Coding API 이중 클라이언트 지원","reasoning_content 필드 지원 (glm-4.7-flash 응답)","useCodingAPI=true면 glm-4.7, false면 glm-4.7-flash 사용"]}
{"type":"entity","name":"[moonbot]::Integration::ZAI_GLMApi","entityType":"integration","observations":["Z.AI API 통합: https://api.z.ai/api/paas/v4/","Coding API: https://api.z.ai/api/coding/paas/v4/","무료 모델 glm-4.7-flash (잔액 불필요)","유료 모델 glm-4.7 (Coding API 전용)","환경변수: ZAI_API_KEY, ZAI_USE_CODING_API, ZAI_MODEL"]}
{"type":"entity","name":"[moonbot]::Convention::LLMModelSelection","entityType":"convention","observations":["Provider 타입별 모델 선택: LLMClient 생성자에서 처리","glm provider면 config.glmModel 우선, openai면 config.model 우선","기본값: glm-4.7-flash (무료), gpt-4o (openai)"]}
{"type":"entity","name":"[moonbot]::Feature::EnvAutoLoad","entityType":"feature","observations":["dotenv 패키지로 .env 자동 로드","gateway/index.ts 상단에 import 'dotenv/config' 추가","applyLLMEnvironmentVariables()로 환경변수 처리","ZAI_USE_CODING_API=true면 glm-4.7 + coding endpoint 사용"]}
{"type":"entity","name":"[moonbot]::Component::DiscordApprovalHandler","entityType":"component","observations":["Discord 승인 핸들러 구현 완료 (src/tools/approval/handlers/discord-approval.ts)","sendEmbed(), sendUpdate() 메서드로 Discord 승인 메시지 전송","formatApprovalEmbed(), formatApprovalUpdateEmbed()로 Embed 포맷 생성","승인 버튼 컴포넌트: createApprovalButtons()","P2 TODO 완료 (2026-01-29)"]}
{"type":"entity","name":"[moonbot]::Component::LLMInfrastructure","entityType":"component","observations":["LLM 인프라 구현 완료 (P0 TODO 해결)","/src/llm/ 디렉토리: LLMClient, LLMProviderFactory, providers/","지원 프로바이더: OpenAI, GLM(Z.AI)","LLMProviderFactory.detectProvider()로 자동 감지","환경변수: OPENAI_API_KEY, ZAI_API_KEY, LLM_PROVIDER","GLM coding API 지원 (glm-4.7, glm-4.7-flash)"]}
{"type":"entity","name":"[moonbot]::Milestone::P0P1P2Completed","entityType":"milestone","observations":["P0 TODO: LLM 연동 완료 (Planner LLMClient)","P1 TODO: Cron Agent 연동 완료","P1 TODO: Approval flow 구현 완료","P2 TODO: Discord 승인 핸들러 완료","문서 현행화: agent_system_spec.md v2.1, local_ai_agent_prd.md v2.1","2026-01-29: 문서에 완료 상태 반영 완료"]}
{"type":"entity","name":"moonbot::Component::Executor","entityType":"component","observations":["LLMClient를 사용해 최종 응답 생성 (assistant/result 메시지가 없을 때)","tool 메시지에서 결과를 모아 toolContext 요약 생성","LLM 미설정/실패 시 fallback 응답 메시지 반환"]}
{"type":"entity","name":"moonbot::Component::LLMClient","entityType":"component","observations":["generateResponse()로 계획 없이 직접 응답 생성 지원","응답 전용 system/user prompt 추가 (toolContext, sessionContext 포함 가능)"]}
{"type":"entity","name":"moonbot::Component::TaskOrchestrator","entityType":"component","observations":["기본 taskTimeoutMs를 600000ms(10분)로 상향"]}
{"type":"entity","name":"moonbot::Component::DevScripts","entityType":"component","observations":["개발용 start/stop/restart 스크립트 추가 (scripts/dev.ps1)","PID 파일은 .moonbot-dev/에 저장","stdout/stderr 로그 분리: gateway.log/gateway.error.log, discord-bot.log/discord-bot.error.log","package.json에 dev:start/dev:stop/dev:restart 스크립트 추가"]}
{"type":"entity","name":"moonbot::Component::ToolResultBuilder","entityType":"component","observations":["ToolResult 생성 헬퍼 (src/tools/runtime/ToolResultBuilder.ts)","success/failure/timeout/cancelled 등 표준 결과 생성 메서드 제공","failure는 ToolResult<never> 반환으로 타입 공변성 문제 해결"]}
{"type":"entity","name":"moonbot::Component::Tools","entityType":"component","observations":["Toolkit.getDefinitions()로 ToolDefinition 목록 제공 (LLM 프롬프트용)","Browser/HTTP/FileIO/SystemRun 도구가 ToolResultBuilder로 결과 생성하도록 마이그레이션","ToolDefinition/ToolMeta 타입 추가 (src/types/index.ts)"]}
{"type":"entity","name":"moonbot::Component::LLMClient","entityType":"component","observations":["LLM system prompt에 ToolDefinition 목록 포함 (toolDefinitions 지원)","formatToolDefinition()로 프롬프트용 포맷 변환"]}
{"type":"entity","name":"moonbot::Component::Planner","entityType":"component","observations":["ToolDefinition[]을 받아 LLMClient에 전달하도록 생성자/plan() 업데이트","parsePlanResponse에서 step.input 파싱 추가"]}
{"type":"entity","name":"moonbot::Tool::ToolResultBuilder","entityType":"component","observations":["위치: src/tools/runtime/ToolResultBuilder.ts","목적: 툴 실행 결과 생성을 위한 헬퍼 클래스","메서드: success(), failure(), timeout(), cancelled(), failureWithDuration()","반환 타입: ToolResult<T>, failure는 ToolResult<never> 반환 (공변성 해결)","사용: 모든 툴에서 일관된 결과 형식 보장","작성일: 2026-01-30"]}
{"type":"entity","name":"moonbot::Tool::ToolProfile","entityType":"component","observations":["위치: src/tools/policy/ToolProfile.ts","목적: 툴 프로필별 필터링 시스템","프로필: minimal (fs.read, fs.list, fs.glob), coding (+fs.write, system.*, http.*), full (모든 툴)","함수: filterToolsByProfile()로 툴 필터링","createGatewayTools()의 profile 옵션으로 사용","작성일: 2026-01-30"]}
{"type":"entity","name":"moonbot::Tool::TypeBoxSchemas","entityType":"component","observations":["위치: src/tools/schemas/TypeBoxSchemas.ts","목적: TypeBox를 사용한 컴파일 타임 타입 안전성 제공","스키마: 24개 (File I/O: 8개, HTTP: 4개, System: 3개, Browser: 7개, Utility: 2개)","함수: toJSONSchema()로 TypeBox -> JSON Schema 변환","장점: 단일 진실 공급원(SSOT), IDE 자동완성, 타입 안전성","적용: 모든 툴 (FileIO, Http, System, Browser)","작성일: 2026-01-30"]}
{"type":"entity","name":"moonbot::Tool::ToolDefinition","entityType":"type","observations":["목적: LLM을 위한 툴 정의 메타데이터","구조: { name, description, schema }","사용: LLMClient.buildSystemPrompt()에서 툴 스키마 포함","메서드: Toolkit.getDefinitions()으로 생성","LLM에게 툴 사용법 전달하는 핵심 인터페이스","추가일: 2026-01-30"]}
{"type":"entity","name":"moonbot::Tool::ToolMeta","entityType":"type","observations":["목적: 툴 실행 결과 메타데이터","구조: { durationMs, artifacts?, truncated? }","사용: ToolResult의 meta 필드","지원: 성공/실패 모두 메타데이터 포함 가능","추가일: 2026-01-30"]}
{"type":"entity","name":"moonbot::Tool::FileIOTool","entityType":"component","observations":["위치: src/tools/filesystem/FileIOTool.ts","툴: fs.read, fs.write, fs.list, fs.glob","경로 검증: PathValidator.validate()로 디렉토리 트래버설 방지","크기 제한: ctx.policy.maxBytes로 파일 크기 제한","원자적 쓰기: atomic 옵션으로 임시 파일 후 rename","TypeBox 스키마 적용 완료 (2026-01-30)","ToolResultBuilder 적용 완료 (2026-01-30)"]}
{"type":"entity","name":"moonbot::Tool::HttpTool","entityType":"component","observations":["위치: src/tools/http/HttpTool.ts","툴: http.request, http.download","SSRF 보호: SsrfGuard.checkUrl()","헤더 검증: validateHeaders()로 XSS/인젝션 방지","위험 헤더 차단: host, referer, origin, cookie, authorization 등","크기 제한: MAX_RESPONSE_SIZE = 10MB","TypeBox 스키마 적용 완료 (2026-01-30)","ToolResultBuilder 적용 완료 (2026-01-30)"]}
{"type":"entity","name":"moonbot::Tool::SystemRunTool","entityType":"component","observations":["위치: src/tools/desktop/SystemRunTool.ts","툴: system.run, system.runRaw (deprecated)","승인 필수: requiresApproval: true","명령어 검증: CommandSanitizer로 위험 명령어 필터링","출력 제한: MAX_OUTPUT_SIZE = 1MB (stdout/stderr)","타임아웃: timeoutMs 옵션 (기본 30초)","TypeBox 스키마 적용 완료 (2026-01-30)","ToolResultBuilder 적용 완료 (2026-01-30)"]}
{"type":"entity","name":"moonbot::Tool::BrowserTool","entityType":"component","observations":["위치: src/tools/browser/BrowserTool.ts","툴: browser.start, browser.goto, browser.snapshot, browser.act, browser.screenshot, browser.extract, browser.close","세션 관리: SessionManager로 병렬 실행 제어 (최대 5개)","보안: HTTPS만 허용, file:// 프로토콜 차단","프레임워크: Playwright (Chromium)","TypeBox 스키마 적용 완료 (2026-01-30)","ToolResultBuilder 적용 완료 (2026-01-30)"]}
{"type":"entity","name":"moonbot::Convention::ToolExposure","entityType":"convention","observations":["도구 정보는 두 채널로 전달: (1) 시스템 프롬프트 텍스트, (2) 도구 스키마","응답용 프롬프트에도 도구 목록 포함 (몰트봇 패턴)","사용자가 '어떤 도구가 있냐'고 물으면 LLM이 자체적으로 도구 목록 안내","buildResponseSystemPrompt()에서 toolDefinitions 파라미터로 도구 정의 수용"]}
{"type":"entity","name":"moonbot::Pattern::MoltbotToolIntegration","entityType":"pattern","observations":["몰트봇 패턴: 시스템 프롬프트에 '## Available Tools' 섹션 포함","각 도구의 이름, 설명, 매개변수를 인간이 읽을 수 있는 형태로 포함","도구 스키마를 구조화된 형태로 API에 전달","모델은 '어떤 도구가 존재하는지'와 '어떻게 호출해야 하는지'를 동시에 이해"]}
{"type":"entity","name":"[moonbot]::Boundary::AlwaysDo","entityType":"boundary","observations":["커밋 전 pnpm build 실행하여 타입 체크","새 도구 추가 시 ToolProfile.ts에 등록","TypeBox 스키마 사용하여 입출력 타입 정의"]}
{"type":"entity","name":"[moonbot]::Boundary::AskFirst","entityType":"boundary","observations":["새 외부 의존성 추가","process.exec 같은 위험한 명령어 실행 도구","시스템 리소스 제한 변경 (세션 수, 버퍼 크기 등)"]}
{"type":"entity","name":"[moonbot]::Boundary::NeverDo","entityType":"boundary","observations":[".env 파일 커밋","승인 없이 system.runRaw 사용","사용자 세션 격리 우회"]}
{"type":"entity","name":"[moonbot]::Component::ProcessTool","entityType":"component","observations":["터미널 프로세스 관리 도구 (6개: exec, write, poll, log, kill, list)","process.exec만 승인 필요, 나머지는 세션 내 작업","userId 기반 세션 격리로 보안 확보","파일: src/tools/process/ProcessTool.ts"]}
{"type":"entity","name":"[moonbot]::Component::ProcessSessionManager","entityType":"component","observations":["프로세스 세션 라이프사이클 관리","사용자당 최대 3개 세션 제한","출력 버퍼 10MB, 유휴 타임아웃 30분","파일: src/tools/process/ProcessSessionManager.ts"]}
{"type":"entity","name":"[moonbot]::Component::PtyWrapper","entityType":"component","observations":["node-pty 동적 로딩 + child_process fallback","WrappedProcess 통합 인터페이스 제공","optional dependency로 설치 실패해도 동작","파일: src/tools/process/PtyWrapper.ts"]}
{"type":"entity","name":"[moonbot]::Convention::ToolPattern","entityType":"convention","observations":["createXxxTool(deps): ToolSpec<Input, Output> 팩토리 함수 패턴","ToolResultBuilder.success() / failureWithDuration() 사용","ApprovalManager.checkApproval() + CommandSanitizer.sanitize() 보안 검증"]}
{"type":"entity","name":"[moonbot]::Convention::SessionManagerPattern","entityType":"convention","observations":["Map<string, Session>으로 세션 저장","cleanupExpired() 메서드로 주기적 정리","lastActivityAt 필드로 유휴 시간 추적"]}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Channels","relationType":"manages"}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Agents","relationType":"orchestrates"}
{"type":"relation","from":"moonbot::Component::Agents","to":"moonbot::Component::Tools","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Sessions","relationType":"manages"}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Auth","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::Channels","to":"moonbot::Component::Auth","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::CLI","to":"moonbot::Component::Gateway","relationType":"communicates"}
{"type":"relation","from":"moonbot::Component::ChannelCommand","to":"moonbot::Component::ChannelHandler","relationType":"calls"}
{"type":"relation","from":"moonbot::Component::ChannelHandler","to":"moonbot::Component::ConfigManager","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::ConfigManager","to":"moonbot::API::EnvironmentVariables","relationType":"loads"}
{"type":"relation","from":"moonbot::Component::ChannelCommand","to":"moonbot::Convention::TokenMasking","relationType":"follows"}
{"type":"relation","from":"moonbot::Component::ConfigManager","to":"moonbot::Convention::TokenMasking","relationType":"implements"}
{"type":"relation","from":"moonbot::Component::ConfigCommand","to":"moonbot::Component::ConfigManager","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::DiscordBot","to":"moonbot::Component::Channels","relationType":"instantiates"}
{"type":"relation","from":"moonbot::Component::Channels","to":"moonbot::Component::ChannelGatewayClient","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::ChannelGatewayClient","to":"moonbot::Component::Gateway","relationType":"connects"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Component::TaskRegistry","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Component::PerChannelQueue","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::API::chat.send","relationType":"receives_from"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::API::chat.response","relationType":"broadcasts_to"}
{"type":"relation","from":"moonbot::Convention::TaskStateMachine","to":"moonbot::Component::TaskRegistry","relationType":"defines_behavior_of"}
{"type":"relation","from":"moonbot::Convention::ErrorFormat","to":"moonbot::Component::TaskOrchestrator","relationType":"defines_behavior_of"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::Component::TaskOrchestrator","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::API::chat.send","relationType":"defines"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::API::chat.response","relationType":"broadcasts"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moon-bot::Component::SessionKey","relationType":"uses"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moon-bot::Convention::TaskState","relationType":"implements"}
{"type":"relation","from":"moon-bot::Feature::TaskOrchestratorExecutorIntegration","to":"moon-bot::Component::TaskOrchestrator","relationType":"updates"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moonbot::Component::TaskRegistry","relationType":"extends"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moonbot::Component::PerChannelQueue","relationType":"extends"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Pattern::ApprovalFlow","relationType":"implements"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Type::ApprovalRequestEvent","relationType":"emits"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Type::ApprovalResolvedEvent","relationType":"emits"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::Pattern::ApprovalFlow","relationType":"implements_rpc_handlers_for"}
{"type":"relation","from":"moonbot::TestingFramework::Vitest","to":"moonbot::Component::TaskOrchestrator","relationType":"tests"}
{"type":"relation","from":"moonbot::TestingFramework::Vitest","to":"moonbot::Component::PerChannelQueue","relationType":"tests"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::Component::TaskOrchestrator","relationType":"orchestrates_approval_events"}
{"type":"relation","from":"moonbot::Component::Planner","to":"moonbot::Component::LLMClient","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::Planner","to":"moonbot::Integration::OpenAI","relationType":"integrates"}
{"type":"relation","from":"moonbot::Component::Executor","to":"moonbot::Component::DiscordAdapter","relationType":"sends_approval_to"}
{"type":"relation","from":"moonbot::Component::CronManager","to":"moonbot::Component::TaskOrchestrator","relationType":"delegates_to"}
{"type":"relation","from":"[moonbot]::Component::LLMProviderFactory","to":"[moonbot]::Component::GLMProvider","relationType":"creates"}
{"type":"relation","from":"[moonbot]::Component::GLMProvider","to":"[moonbot]::Integration::ZAI_GLMApi","relationType":"implements"}
{"type":"relation","from":"[moonbot]::Component::LLMClient","to":"[moonbot]::Component::LLMProviderFactory","relationType":"uses"}
{"type":"relation","from":"[moonbot]::Feature::EnvAutoLoad","to":"[moonbot]::Convention::LLMModelSelection","relationType":"enables"}
{"type":"relation","from":"[moonbot]::Component::LLMInfrastructure","to":"moonbot::Component::Agents","relationType":"enables"}
{"type":"relation","from":"[moonbot]::Component::LLMInfrastructure","to":"[moonbot]::Component::LLMProviderFactory","relationType":"includes"}
{"type":"relation","from":"[moonbot]::Component::LLMInfrastructure","to":"moonbot::Component::LLMClient","relationType":"includes"}
{"type":"relation","from":"[moonbot]::Component::DiscordApprovalHandler","to":"moonbot::Pattern::ApprovalFlow","relationType":"implements"}
{"type":"relation","from":"moonbot::Component::Cron","to":"moonbot::Component::TaskOrchestrator","relationType":"delegates_to"}
{"type":"relation","from":"moonbot::Component::Tools","to":"moonbot::Component::ToolResultBuilder","relationType":"uses"}
{"type":"relation","from":"moonbot::Convention::ToolExposure","to":"moonbot::Component::LLMClient","relationType":"implemented_by"}
{"type":"relation","from":"moonbot::Pattern::MoltbotToolIntegration","to":"moonbot::Convention::ToolExposure","relationType":"defines"}
{"type":"relation","from":"moonbot::Component::Executor","to":"moonbot::Convention::ToolExposure","relationType":"follows"}
{"type":"relation","from":"[moonbot]::Component::ProcessTool","to":"[moonbot]::Component::ProcessSessionManager","relationType":"uses"}
{"type":"relation","from":"[moonbot]::Component::ProcessSessionManager","to":"[moonbot]::Component::PtyWrapper","relationType":"uses"}