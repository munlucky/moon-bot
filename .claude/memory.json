{"type":"entity","name":"moonbot::Boundary::AlwaysDo","entityType":"boundary","observations":["커밋 전 pnpm lint 실행","TypeScript 빌드 통과 확인 (pnpm build)","보안 검토 후 하드코딩된 시크릿 없는지 확인","*-config.json 파일 .gitignore에 추가","개인 설정 파일 커밋 전 확인"]}
{"type":"entity","name":"moonbot::Boundary::AskFirst","entityType":"boundary","observations":["새로운 채널 어댑터 추가 시","외부 포트 바인딩 설정 변경 시","세션 저장 경로 구조 변경 시","핵심 도구(Browser, HTTP, Desktop) 승인 정책 수정 시"]}
{"type":"entity","name":"moonbot::Boundary::NeverDo","entityType":"boundary","observations":["하드코딩된 API 키/토큰 커밋",".env 파일 커밋","루프백이 아닌 외부 바인딩 시 인증 없이 노출","SSRF 보호 없이 HTTP 도구 사용"]}
{"type":"entity","name":"moonbot::Component::Gateway","entityType":"component","observations":["WebSocket 서버 (포트 18789)","JSON-RPC 프로토콜 핸들러","세션/채널/노드/훅 통합 관리","파일 위치: src/gateway/","chat.send 핸들러: 처리 후 chat.response 브로드캐스트","TaskResponse 타입 도입 (channelId, text, status, metadata)"]}
{"type":"entity","name":"moonbot::Component::Channels","entityType":"component","observations":["멀티 서피스 채널 어댑터","Discord 어댑터 구현 (discord.js)","Mention Gating (@agent 언급 시만 활성화)","DM 페어링 승인 흐름","파일 위치: src/channels/","Discord Adapter: ChannelGatewayClient 통합 (자동 Gateway 연결)","chat.response notification 수신 및 Discord 채널로 전달","sendToGateway: WebSocket으로 chat.send RPC 호출"]}
{"type":"entity","name":"moonbot::Component::Agents","entityType":"component","observations":["Planner-Executor-Replanner 모델","Planner: 목표 분해 (고성능 LLM)","Executor: 도구 호출 및 결과 수집","Replanner: 실패 시 대체 도구 선택","파일 위치: src/agents/"]}
{"type":"entity","name":"moonbot::Component::Tools","entityType":"component","observations":["TypeBox 기반 JSON Schema 계약","Browser Tool: Playwright 웹 제어","HTTP Tool: API 호출 + SSRF 가드","Filesystem Tool: 파일 I/O + 경로 검증","Desktop Tool: system.run + 명령어 sanitization","Approval System: Lobster 승인 흐름","파일 위치: src/tools/"]}
{"type":"entity","name":"moonbot::Component::Sessions","entityType":"component","observations":["JSONL 형식 저장","저장 경로: ~/.clawdbot/agents/<agentId>/sessions/<sessionId>.jsonl","세션 공유 (sessions.send)","컴팩션 및 리플레이 기능","파일 위치: src/sessions/"]}
{"type":"entity","name":"moonbot::Component::Cron","entityType":"component","observations":["예약 작업 관리","cron.list, cron.edit, cron.run 명령","하트비트 및 이벤트 기반 발화","파일 위치: src/cron/"]}
{"type":"entity","name":"moonbot::Component::Auth","entityType":"component","observations":["사용자 페어링 승인","인증 토큰 관리","allowFrom 기반 접근 제어","파일 위치: src/auth/"]}
{"type":"entity","name":"moonbot::Component::CLI","entityType":"component","observations":["명령어: moonbot gateway status, logs, doctor, call, pairing","Gateway 직접 RPC 호출 지원","보안/권한 진단 기능","파일 위치: src/cli/","npm 스크립트: cli (node dist/cli.js)","npm 스크립트: discord (node dist/discord-bot.js)"]}
{"type":"entity","name":"moonbot::Convention::ToolRegistration","entityType":"convention","observations":["toolkit.register({ id, schema, run }) 인터페이스","TypeBox 사용한 스키마 정의","requiresApproval 옵션으로 승인 필요 도구 지정","평탄화된 구조 권장"]}
{"type":"entity","name":"moonbot::Convention::Naming","entityType":"convention","observations":["컴포넌트 파일: PascalCase (예: BrowserTool.ts)","타입 정의: 인터페이스/타입 분리","CLI 명령: kebab-case (예: gateway status)"]}
{"type":"entity","name":"moonbot","entityType":"project","observations":["Local-first AI Agent System","Moltbot 프레임워크 기반","TypeScript (ESM), Node.js 22+","WebSocket JSON-RPC (포트 18789)","멀티 서피스 채널 (Discord 등)","CLI: moonbot","PRD: local_ai_agent_prd.md","Spec: agent_system_spec.md","README.md 문서 추가 (프로젝트 개요, 설치, 빠른 시작 가이드)","문서: USER_GUIDE.md (사용자 가이드, 채널별 설정, config import 가이드)","예제 설정: docs/config.example.json"]}
{"type":"entity","name":"moonbot::Component::ChannelCommand","entityType":"component","observations":["CLI 채널 관리 명령어 (add, remove, list, enable, disable)","위치: src/cli/commands/channel.ts","RPC 클라이언트를 통해 Gateway와 통신","토큰 마스킹 기능 적용 (maskToken)","에러 핸들링: ECONNREFUSED, not found, already exists"]}
{"type":"entity","name":"moonbot::Component::ConfigManager","entityType":"component","observations":["설정 관리자 모듈","위치: src/config/manager.ts","기능: loadConfigAsync, saveConfig, addChannel, removeChannel, updateChannel","환경 변수 우선순위: env > config.json > defaults","자동 백업 (최대 10개 보관)","토큰 마스킹 함수 제공"]}
{"type":"entity","name":"moonbot::Component::ChannelHandler","entityType":"component","observations":["Gateway RPC 채널 핸들러","위치: src/gateway/handlers/channel.handler.ts","메서드: list, add, remove, enable, disable, get","ConfigManager를 통해 설정 파일 CRUD"]}
{"type":"entity","name":"moonbot::API::EnvironmentVariables","entityType":"api","observations":["지원 변수: MOONBOT_DISCORD_TOKEN, MOONBOT_GATEWAY_PORT, MOONBOT_GATEWAY_HOST","우선순위: 환경 변수 > config.json > 기본값","Discord 토큰이 있으면 자동으로 discord 채널 생성/업�데이트"]}
{"type":"entity","name":"moonbot::Convention::TokenMasking","entityType":"convention","observations":["보안을 위해 모든 토큰 출력 시 마스킹 적용","형식: 앞 6자리 + ... + 뒤 4자리","함수: maskToken() in src/config/manager.ts","적용 위치: channel list, channel add 출력"]}
{"type":"entity","name":"moonbot::Convention::EnvVarNaming","entityType":"convention","observations":["환경 변수 네이밍: MOONBOT_<SECTION>_<KEY>","예: MOONBOT_DISCORD_TOKEN, MOONBOT_GATEWAY_PORT","섹션: DISCORD, GATEWAY, STORAGE 등"]}
{"type":"entity","name":"moonbot::Component::ConfigCommand","entityType":"component","observations":["CLI 설정 관리 명령어 (import, export, path)","위치: src/cli/commands/config.ts","config import <file>: JSON 파일에서 설정 가져오기","config export <file>: 현재 설정 내보내기","config path: 설정 파일 위치 표시","--force 옵션으로 기존 설정 덮어쓰기","자동 백업 생성 (최대 10개 보관)"]}
{"type":"entity","name":"moonbot::Component::DiscordBot","entityType":"component","observations":["Discord 봇 실행 엔트리 포인트","위치: src/discord-bot.ts","활성화된 Discord 채널 자동 시작","SIGINT 핸들링으로 graceful shutdown","별도 프로세스로 실행 (npm run discord)"]}
{"type":"entity","name":"moonbot::Component::ChannelGatewayClient","entityType":"component","observations":["채널 어댑터용 WebSocket 클라이언트","위치: src/channels/GatewayClient.ts","자동 재연결 (exponential backoff, 최대 10회)","EventEmitter 기반 notification 핸들링","RPC 타임아웃 (30초 기본)","Gateway와 JSON-RPC 통신"]}
{"type":"entity","name":"moonbot::Component::TaskOrchestrator","entityType":"component","observations":["태스크 생성 및 상태 관리 (PENDING/RUNNING/FAILED/DONE)","Per-channel 실행 큐 관리","Gateway에서 chat.send 요청을 받아 Task로 변환","Task 실행 결과를 chat.response로 브로드캐스트","src/orchestrator/TaskOrchestrator.ts가 핵심 구현체","2026-01-29: 스켈레톤 구현 완료 (Echo placeholder 포함)","grantApproval(taskId, approved): PAUSED 상태 태스크 승인/거부 메서드 추가","getPendingApprovals(): 대기 중 승인 목록 반환 메서드 추가","onApprovalRequest(callback): 승인 요청 이벤트 콜백 등록 메서드 추가","onApprovalResolved(callback): 승인 완료 이벤트 콜백 등록 메서드 추가","emitApprovalRequest(): 승인 요청 이벤트 방출 메서드 추가","emitApprovalResolved(): 승인 완료 이벤트 방출 메서드 추가","ApprovalRequestEvent, ApprovalResolvedEvent 타입 사용","27개 단위 테스트로 기능 검증 완료"]}
{"type":"entity","name":"moonbot::Component::TaskRegistry","entityType":"component","observations":["In-memory Task 저장소","Task 상태 전이 관리 (PENDING -> RUNNING -> FAILED|DONE)","task_id 생성 규칙: UUID + timestamp","Task 이벤트 리스너 지원","src/orchestrator/TaskRegistry.ts에 구현"]}
{"type":"entity","name":"moonbot::Component::PerChannelQueue","entityType":"component","observations":["채널별 독립적인 FIFO 큐","채널 간 병렬 처리 가능하지만 동일 채널 내 순서 보장","처리 중 상태 추적 (startProcessing/stopProcessing)","최대 큐 크기 제한 (기본 100)","src/orchestrator/PerChannelQueue.ts에 구현","remove(item) 메서드 추가: 큐에서 항목 제거","채널 격리 테스트: 다른 채널 간 큐 독립성 검증","42개 단위 테스트로 기능 검증 완료 (enqueue/dequeue, FIFO, queue full, channel isolation, remove, processing state, getStats, clear, cleanup)"]}
{"type":"entity","name":"moonbot::API::chat.send","entityType":"api","observations":["Gateway RPC 메서드","채널에서 메시지를 받아 TaskOrchestrator로 위임","ChatMessage 파라미터: {agentId, text, userId, channelId, metadata}","반환값: {status, taskId, state}","src/gateway/server.ts에 구현"]}
{"type":"entity","name":"moonbot::API::chat.response","entityType":"api","observations":["Gateway notification 메서드","Task 실행 결과를 채널로 브로드캐스트","TaskResponse 포맷: {taskId?, channelId, text, status, metadata}","DiscordAdapter가 수신하여 Discord로 전송"]}
{"type":"entity","name":"moonbot::Convention::TaskStateMachine","entityType":"convention","observations":["Task 상태: PENDING -> RUNNING -> (FAILED|DONE)","상태 전이 유효성 검사: PENDING->RUNNING, RUNNING->DONE/FAILED만 허용","task_id는 UUID + timestamp로 고유성 보장","channelSessionId를 기준으로 per-channel 큐에 등록"]}
{"type":"entity","name":"moonbot::Convention::ErrorFormat","entityType":"convention","observations":["에러 포맷 분리: 사용자 메시지(userMessage) vs 내부 로그(internalMessage)","userMessage: 채널로 전송되는 사용자 친화적 메시지","internalMessage: 로그에만 남기는 상세 내용","코드 포맷: {code, userMessage, internalMessage?, stack?}"]}
{"type":"entity","name":"moonbot::Component::GatewayServer","entityType":"component","observations":["WebSocket 기반 Gateway 서버","JSON-RPC 메시지 처리","ToolRuntime 통합","2026-01-29: TaskOrchestrator 통합 완료","생성자에서 TaskOrchestrator 초기화 및 onResponse callback 등록","chat.send 핸들러에서 Orchestrator.createTask로 위임","stop() 시 orchestrator.shutdown() 호출","getOrchestrator() 메서드 추가","approval.grant RPC 핸들러: PAUSED 태스크 승인/거소 처리","approval.list RPC 핸들러: 대기 중 승인 목록 반환","orchestrator.onApprovalRequest() 콜백 연결: 'approval.requested' 브로드캐스트","orchestrator.onApprovalResolved() 콜백 연결: 'approval.resolved' 브로드캐스트"]}
{"type":"entity","name":"moonbot::Type::Task","entityType":"type","observations":["Task 인터페이스 정의 (src/types/index.ts)","필드: id, state, channelSessionId, message, createdAt, updatedAt, error?, result?","TaskState 타입: PENDING | RUNNING | FAILED | DONE","TaskError 타입: {code, userMessage, internalMessage?, stack?}","TaskEvent 타입: {taskId, previousState, newState, timestamp}"]}
{"type":"entity","name":"moon-bot::Component::TaskOrchestrator","entityType":"component","observations":["태스크 라이프사이클 관리 및 채널별 큐 실행","Executor와 통합하여 실제 작업 실행","승인 이벤트 핸들링 (APPROVAL_REQUESTED/RESOLVED)","TaskStateChangeEvent 방출 (채널 ID 포함)","abortTask() 메서드로 태스크 중단 지원","Toolkit, SessionManager, Executor 의존성 주입","sessionTaskMap으로 세션-태스크 매핑"]}
{"type":"entity","name":"moon-bot::Component::SessionKey","entityType":"component","observations":["Moltbot 호환 sessionKey 유틸리티","형식: agent:<id>:session:<key>","parse(), generate(), isValid() 함수 제공","src/sessions/SessionKey.ts에 구현"]}
{"type":"entity","name":"moon-bot::Convention::TaskState","entityType":"convention","observations":["태스크 상태: PENDING -> RUNNING -> DONE/FAILED/PAUSED/ABORTED","PAUSED 상태는 승인 대기 중임을 나타냄","ABORTED 상태는 사용자 요청 또는 거부로 중단됨","TaskRegistry에서 상태 전이 규칙 검증"]}
{"type":"entity","name":"moon-bot::Feature::TaskOrchestratorExecutorIntegration","entityType":"feature","observations":["P0: TaskState 확장, SessionKey, Executor 통합, 의존성 주입 완료","P1: 승인 이벤트 핸들러, 상태 이벤트 방출, abortTask() 구현 완료","TypeScript 컴파일 검증 통과","커밋 aea5ab4: 7개 파일, 507줄 추가"]}
{"type":"entity","name":"moonbot::TestingFramework::Vitest","entityType":"testing-framework","observations":["Vitest 테스트 프레임워크 추가 (2026-01-29)","Node 환경 설정 (environment: 'node')","V8 커버리지 도구 사용 (@vitest/coverage-v8)","설정 파일: vitest.config.ts","테스트 파일: *.test.ts 패턴","PerChannelQueue: 42개 단위 테스트 (enqueue/dequeue, FIFO, queue full, channel isolation, remove method, processing state, getStats, clear, cleanup)","TaskOrchestrator: 27개 단위 테스트 (task creation, state transitions, timeout, abort, approval flow, callbacks, stats, cleanup, edge cases)","pnpm devDependencies: vitest, @vitest/coverage-v8"]}
{"type":"entity","name":"moonbot::Type::ApprovalRequestEvent","entityType":"type","observations":["승인 요청 이벤트 타입 (src/orchestrator/types.ts)","필드: taskId (string), channelId (string), toolId (string), input (unknown), requestId (string)","TaskOrchestrator에서 승인이 필요한 작업 요청 시 방출","Gateway Server를 통해 클라이언트로 'approval.requested' notification 브로드캐스트"]}
{"type":"entity","name":"moonbot::Type::ApprovalResolvedEvent","entityType":"type","observations":["승인 결과 이벤트 타입 (src/orchestrator/types.ts)","필드: taskId (string), channelId (string), approved (boolean), requestId (string)","TaskOrchestrator에서 승인/거부 결정 후 방출","Gateway Server를 통해 클라이언트로 'approval.resolved' notification 브로드캐스트"]}
{"type":"entity","name":"moonbot::Pattern::ApprovalFlow","entityType":"pattern","observations":["승인 흐름 패턴: Task PAUSED -> 승인 요청 -> 승인/거부 -> Task 상태 변경","TaskOrchestrator.grantApproval(taskId, approved): PAUSED 상태 태스크 승인/거부","TaskOrchestrator.getPendingApprovals(): 대기 중 승인 목록 반환","TaskOrchestrator.onApprovalRequest(callback): 승인 요청 이벤트 리스너 등록","TaskOrchestrator.onApprovalResolved(callback): 승인 완료 이벤트 리스너 등록","Gateway Server RPC handlers: approval.grant (승인/거부), approval.list (대기 목록 조회)","이벤트 방출: emitApprovalRequest(), emitApprovalResolved()"]}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Channels","relationType":"manages"}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Agents","relationType":"orchestrates"}
{"type":"relation","from":"moonbot::Component::Agents","to":"moonbot::Component::Tools","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Sessions","relationType":"manages"}
{"type":"relation","from":"moonbot::Component::Gateway","to":"moonbot::Component::Auth","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::Channels","to":"moonbot::Component::Auth","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::CLI","to":"moonbot::Component::Gateway","relationType":"communicates"}
{"type":"relation","from":"moonbot::Component::ChannelCommand","to":"moonbot::Component::ChannelHandler","relationType":"calls"}
{"type":"relation","from":"moonbot::Component::ChannelHandler","to":"moonbot::Component::ConfigManager","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::ConfigManager","to":"moonbot::API::EnvironmentVariables","relationType":"loads"}
{"type":"relation","from":"moonbot::Component::ChannelCommand","to":"moonbot::Convention::TokenMasking","relationType":"follows"}
{"type":"relation","from":"moonbot::Component::ConfigManager","to":"moonbot::Convention::TokenMasking","relationType":"implements"}
{"type":"relation","from":"moonbot::Component::ConfigCommand","to":"moonbot::Component::ConfigManager","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::DiscordBot","to":"moonbot::Component::Channels","relationType":"instantiates"}
{"type":"relation","from":"moonbot::Component::Channels","to":"moonbot::Component::ChannelGatewayClient","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::ChannelGatewayClient","to":"moonbot::Component::Gateway","relationType":"connects"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Component::TaskRegistry","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Component::PerChannelQueue","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::API::chat.send","relationType":"receives_from"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::API::chat.response","relationType":"broadcasts_to"}
{"type":"relation","from":"moonbot::Convention::TaskStateMachine","to":"moonbot::Component::TaskRegistry","relationType":"defines_behavior_of"}
{"type":"relation","from":"moonbot::Convention::ErrorFormat","to":"moonbot::Component::TaskOrchestrator","relationType":"defines_behavior_of"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::Component::TaskOrchestrator","relationType":"uses"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::API::chat.send","relationType":"defines"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::API::chat.response","relationType":"broadcasts"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moon-bot::Component::SessionKey","relationType":"uses"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moon-bot::Convention::TaskState","relationType":"implements"}
{"type":"relation","from":"moon-bot::Feature::TaskOrchestratorExecutorIntegration","to":"moon-bot::Component::TaskOrchestrator","relationType":"updates"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moonbot::Component::TaskRegistry","relationType":"extends"}
{"type":"relation","from":"moon-bot::Component::TaskOrchestrator","to":"moonbot::Component::PerChannelQueue","relationType":"extends"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Pattern::ApprovalFlow","relationType":"implements"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Type::ApprovalRequestEvent","relationType":"emits"}
{"type":"relation","from":"moonbot::Component::TaskOrchestrator","to":"moonbot::Type::ApprovalResolvedEvent","relationType":"emits"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::Pattern::ApprovalFlow","relationType":"implements_rpc_handlers_for"}
{"type":"relation","from":"moonbot::TestingFramework::Vitest","to":"moonbot::Component::TaskOrchestrator","relationType":"tests"}
{"type":"relation","from":"moonbot::TestingFramework::Vitest","to":"moonbot::Component::PerChannelQueue","relationType":"tests"}
{"type":"relation","from":"moonbot::Component::GatewayServer","to":"moonbot::Component::TaskOrchestrator","relationType":"orchestrates_approval_events"}